<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ouvidoria CETEP LNAB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="container mt-3">
    <header class="text-center">
      <div class="logo-box">
        <img src="https://i.im.ge/2025/04/11/pVTi0z.logo.png" alt="logo" height="50">
        <h2>Ouvidoria CETEP LNAB</h2>
      </div>
    </header>

    <div class="text-end mb-3">
      <button id="toggleTheme" class="btn btn-outline-secondary btn-sm">Tema Escuro</button>
    </div>

    <div class="d-grid gap-2 col-8 mx-auto mb-4">
      <button class="btn btn-primary" onclick="mostrar('registro')">Registrar Manifestação</button>
      <button class="btn btn-secondary" onclick="mostrar('consulta')">Consultar por Protocolo</button>
      <button class="btn btn-info text-white" onclick="mostrar('consultaCPF')">Consultar por CPF</button>
      <button class="btn btn-warning text-white" onclick="mostrar('consultaMatricula')">Consultar por Matrícula</button> 
      <button class="btn btn-danger" onclick="mostrar('adminLogin')">Acesso do Administrador</button>
    </div>

    <div id="registro" class="card shadow-sm p-4 mb-4 hidden">
      <h4>Registrar Manifestação</h4>
      <form id="formRegistro">
        <div class="mb-3">
          <label for="nome" class="form-label">Nome (opcional)</label>
          <input type="text" id="nome" name="nome" class="form-control">
        </div>
        <div class="mb-3">
          <label for="cpf" class="form-label">CPF</label>
          <input type="text" id="cpf" name="cpf" class="form-control" placeholder="Apenas números" maxlength="11" required>
        </div>
        <div class="mb-3">
          <label for="matricula" class="form-label">Matrícula</label>
          <input type="text" id="matricula" name="matricula" class="form-control" placeholder="Apenas 8 números" maxlength="8" required>
        </div>
        
        <div class="mb-3">
          <label for="tipo" class="form-label">Tipo de Manifestação</label>
          <select id="tipo" name="tipo" class="form-select" required>
            <option value="" disabled selected>Selecione...</option>
            <option value="elogio">Elogio</option>
            <option value="sugestao">Sugestão</option>
            <option value="reclamacao">Reclamação</option>
            <option value="denuncia">Denúncia</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="descricao" class="form-label">Descrição</label>
          <textarea id="descricao" name="descricao" class="form-control" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-success">Enviar</button>
      </form>
    </div>

    <div id="consulta" class="card shadow-sm p-4 mb-4 hidden">
      <h4>Consultar por Protocolo</h4>
      <form id="formConsulta">
        <div class="mb-3">
          <label for="protocolo" class="form-label">Protocolo</label>
          <input type="text" id="protocolo" name="protocolo" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Consultar</button>
      </form>
      <div id="resultadoConsulta" class="mt-3"></div>
    </div>

    <div id="consultaCPF" class="card shadow-sm p-4 mb-4 hidden">
      <h4>Consultar por CPF</h4>
      <form id="formConsultaCPF">
        <div class="mb-3">
          <label for="cpfBusca" class="form-label">CPF</label>
          <input type="text" id="cpfBusca" name="cpfBusca" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-info text-white">Consultar</button>
      </form>
      <div id="resultadoConsultaCPF" class="mt-3"></div>
    </div>
    
    <div id="consultaMatricula" class="card shadow-sm p-4 mb-4 hidden">
      <h4>Consultar por Matrícula</h4>
      <form id="formConsultaMatricula">
        <div class="mb-3">
          <label for="matriculaBusca" class="form-label">Matrícula</label>
          <input type="text" id="matriculaBusca" name="matriculaBusca" class="form-control" placeholder="Apenas 8 números" maxlength="8" required>
        </div>
        <button type="submit" class="btn btn-warning text-white">Consultar</button>
      </form>
      <div id="resultadoConsultaMatricula" class="mt-3"></div>
    </div>

    <div id="adminLogin" class="card shadow-sm p-4 mb-4 hidden">
      <h4>Acesso do Administrador</h4>
      <form id="formAdminLogin">
        <div class="mb-3">
          <label for="usuarioAdmin" class="form-label">Usuário</label>
          <input type="text" id="usuarioAdmin" name="usuarioAdmin" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="senhaAdmin" class="form-label">Senha</label>
          <input type="password" id="senhaAdmin" name="senhaAdmin" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-danger">Entrar</button>
      </form>
      <div id="erroLogin" class="text-danger mt-2"></div>
    </div>

    <div id="confirmacao" class="card shadow-sm p-4 mb-4 hidden text-center">
      <h4 class="text-success">Manifestação registrada com sucesso!</h4>
      <p id="protocoloGerado"></p>
      <button class="btn btn-primary" onclick="mostrar('registro')">Nova Manifestação</button>
      <button class="btn btn-secondary" onclick="mostrar('consulta')">Consultar Protocolo</button>
    </div>
  </div>

<script>
function mostrar(id){
  // Esconde todas as divs com a classe 'card' que contêm 'hidden'
  document.querySelectorAll('.card').forEach(d => d.classList.add('hidden'));
  // Exibe a div com o ID correspondente
  const targetElement = document.getElementById(id);
  if (targetElement) {
    targetElement.classList.remove('hidden');
  }
  // Limpa os resultados de consulta ao mudar a tela
  $('#resultadoConsulta').html('');
  $('#resultadoConsultaCPF').html('');
  $('#resultadoConsultaMatricula').html(''); // NOVO: Limpa a consulta por matrícula
}

const toggleThemeBtn = document.getElementById("toggleTheme");
const body = document.body;
toggleThemeBtn.addEventListener("click", () => {
  body.classList.toggle("dark-theme");
  toggleThemeBtn.textContent = body.classList.contains("dark-theme") ? "Tema Claro" : "Tema Escuro";
});

// FUNÇÃO PADRÃO PARA FORMATAR RESULTADOS (para CPF e Matrícula)
function formatResults(data, targetDivId) {
    if (data.length === 0) $('#' + targetDivId).html('<p class="text-danger">Nenhuma manifestação encontrada.</p>');
    else {
      let html = '';
      data.forEach(d => {
        html += `
        <div class="border p-3 mb-2">
          <p><strong>Protocolo:</strong> ${d.protocolo}</p>
          <p><strong>Nome:</strong> ${d.nome || 'Anônimo'}</p>
          <p><strong>CPF:</strong> ${d.cpf}</p>
          <p><strong>Matrícula:</strong> ${d.matricula || 'Não informada'}</p> 
          <p><strong>Tipo:</strong> ${d.tipo}</p>
          <p><strong>Descrição:</strong> ${d.descricao}</p>`;
        if (d.resposta) html += `<p class="text-success"><strong>Resposta do Admin:</strong> ${d.resposta}</p>`;
        html += `</div>`;
      });
      $('#' + targetDivId).html(html);
    }
}


$('#formRegistro').on('submit', function(e){
  e.preventDefault();
  
  // Limpeza de campos para garantir apenas números antes do envio
  $('#cpf').val($('#cpf').val().replace(/[^0-9]/g, ''));
  $('#matricula').val($('#matricula').val().replace(/[^0-9]/g, '')); 
  
  $.post('/registrar', $(this).serialize(), function(data){
    $('#protocoloGerado').text('Protocolo: ' + data.protocolo);
    mostrar('confirmacao');
  }).fail(function(err){
    alert(err.responseJSON?.erro || 'Erro desconhecido');
  });
});

$('#formConsulta').on('submit', function(e){
  e.preventDefault();
  $.post('/consultar', $(this).serialize(), function(data){
    let html = `
      <div class="border p-3">
        <p><strong>Protocolo:</strong> ${data.protocolo}</p>
        <p><strong>Nome:</strong> ${data.nome || 'Anônimo'}</p>
        <p><strong>CPF:</strong> ${data.cpf}</p>
        <p><strong>Matrícula:</strong> ${data.matricula || 'Não informada'}</p>
        <p><strong>Tipo:</strong> ${data.tipo}</p>
        <p><strong>Descrição:</strong> ${data.descricao}</p>`;
    if (data.resposta) html += `<p class="text-success"><strong>Resposta do Admin:</strong> ${data.resposta}</p>`;
    html += `</div>`;
    $('#resultadoConsulta').html(html);
  }).fail(function(err){
    $('#resultadoConsulta').html('<p class="text-danger">' + (err.responseJSON?.erro || 'Erro desconhecido') + '</p>');
  });
});

$('#formConsultaCPF').on('submit', function(e){
  e.preventDefault();
  // Limpeza do campo CPF
  $('#cpfBusca').val($('#cpfBusca').val().replace(/[^0-9]/g, '')); 
  
  $.post('/consultar_cpf', $(this).serialize(), function(data){
    formatResults(data, 'resultadoConsultaCPF');
  }).fail(function(err){
    $('#resultadoConsultaCPF').html('<p class="text-danger">' + (err.responseJSON?.erro || 'Erro desconhecido') + '</p>');
  });
});

// NOVO SCRIPT: CONSULTA POR MATRÍCULA
$('#formConsultaMatricula').on('submit', function(e){
  e.preventDefault();
  // Limpeza do campo Matrícula
  $('#matriculaBusca').val($('#matriculaBusca').val().replace(/[^0-9]/g, ''));
  
  $.post('/consultar_matricula', $(this).serialize(), function(data){
    formatResults(data, 'resultadoConsultaMatricula');
  }).fail(function(err){
    $('#resultadoConsultaMatricula').html('<p class="text-danger">' + (err.responseJSON?.erro || 'Erro desconhecido') + '</p>');
  });
});

$('#formAdminLogin').on('submit', function(e){
  e.preventDefault();
  $.post('/admin_login', $(this).serialize(), function(data){
    if (data.redirect) window.location.href = data.redirect;
  }).fail(function(err){
    $('#erroLogin').text(err.responseJSON?.erro || 'Usuário ou senha incorretos');
  });
});

// Garante que apenas números sejam digitados em tempo real (boa prática)
document.getElementById('cpf').oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
document.getElementById('matricula').oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
document.getElementById('cpfBusca').oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
document.getElementById('matriculaBusca').oninput = (e) => e.target.value = e.target.value.replace(/[^0-9]/g, '');
</script>
</body>
</html>